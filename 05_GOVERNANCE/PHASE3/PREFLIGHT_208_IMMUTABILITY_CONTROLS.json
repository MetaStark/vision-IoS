{
  "document_id": "PREFLIGHT-208-IMMUTABILITY-CONTROLS",
  "document_type": "GOVERNANCE_SPECIFICATION",
  "classification": "GOVERNANCE-CRITICAL",
  "directive": "CEO-DIR-2026-001",
  "migration": "208_ceo_dir_2026_001_epistemic_separation.sql",
  "timestamp": "2026-01-06T21:00:00Z",
  "author": "STIG",

  "section_1_immutability_principle": {
    "principle": "Model beliefs are APPEND-ONLY",
    "rationale": "CEO-DIR-2026-001 mandates: 'Learning SHALL reference belief, not action.' If beliefs can be modified after the fact, the learning loop cannot trust historical data.",

    "invariants": [
      "Belief records SHALL NOT be modified after creation",
      "Belief records SHALL NOT be deleted",
      "Historical belief state SHALL be replayable at any point in time",
      "The learning system SHALL see exactly what the model believed at time t"
    ]
  },

  "section_2_enforcement_mechanism": {
    "approach": "Database-level trigger enforcement",
    "target_table": "fhq_perception.model_belief_state",

    "recommended_trigger": {
      "name": "trg_model_belief_state_immutable",
      "type": "BEFORE UPDATE OR DELETE",
      "action": "RAISE EXCEPTION 'model_belief_state is immutable per CEO-DIR-2026-001'",

      "sql": "CREATE OR REPLACE FUNCTION fhq_perception.enforce_belief_immutability()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF TG_OP = 'UPDATE' THEN\n        RAISE EXCEPTION 'IMMUTABILITY_VIOLATION: model_belief_state records cannot be modified. Directive: CEO-DIR-2026-001. Attempted to update belief_id: %', OLD.belief_id;\n    ELSIF TG_OP = 'DELETE' THEN\n        RAISE EXCEPTION 'IMMUTABILITY_VIOLATION: model_belief_state records cannot be deleted. Directive: CEO-DIR-2026-001. Attempted to delete belief_id: %', OLD.belief_id;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trg_model_belief_state_immutable\n    BEFORE UPDATE OR DELETE ON fhq_perception.model_belief_state\n    FOR EACH ROW\n    EXECUTE FUNCTION fhq_perception.enforce_belief_immutability();"
    },

    "note": "Trigger is NOT included in Migration 208 - recommended as follow-up Migration 209"
  },

  "section_3_audit_logging_for_violations": {
    "description": "Any immutability violation attempt SHALL be logged",

    "audit_entry_specification": {
      "table": "fhq_governance.governance_actions_log",
      "action_type": "IMMUTABILITY_VIOLATION_ATTEMPT",
      "severity": "CLASS_A_VIOLATION",
      "fields": [
        "attempted_operation (UPDATE/DELETE)",
        "target_belief_id",
        "attempted_by (session user)",
        "timestamp",
        "blocked (TRUE)"
      ]
    }
  },

  "section_4_vega_test_specification": {
    "test_name": "VEGA_TEST_BELIEF_IMMUTABILITY",
    "purpose": "Verify that UPDATE/DELETE on model_belief_state fails",

    "test_cases": [
      {
        "test_id": "T1",
        "description": "Attempt UPDATE on belief_confidence",
        "sql": "UPDATE fhq_perception.model_belief_state SET belief_confidence = 0.99 WHERE belief_id = (SELECT belief_id FROM fhq_perception.model_belief_state LIMIT 1);",
        "expected_result": "ERROR: IMMUTABILITY_VIOLATION",
        "actual_result": "PENDING_TRIGGER_DEPLOYMENT"
      },
      {
        "test_id": "T2",
        "description": "Attempt DELETE on belief record",
        "sql": "DELETE FROM fhq_perception.model_belief_state WHERE belief_id = (SELECT belief_id FROM fhq_perception.model_belief_state LIMIT 1);",
        "expected_result": "ERROR: IMMUTABILITY_VIOLATION",
        "actual_result": "PENDING_TRIGGER_DEPLOYMENT"
      },
      {
        "test_id": "T3",
        "description": "Verify INSERT still works",
        "sql": "INSERT INTO fhq_perception.model_belief_state (asset_id, technical_regime, belief_distribution, belief_confidence, dominant_regime, model_version, inference_engine, lineage_hash) VALUES ('TEST-ASSET', 'NEUTRAL', '{\"BULL\": 0.2, \"BEAR\": 0.2, \"NEUTRAL\": 0.5, \"STRESS\": 0.1}', 0.5, 'NEUTRAL', 'test_v1', 'test_engine', 'test_hash');",
        "expected_result": "SUCCESS (1 row inserted)",
        "cleanup": "DELETE test row after trigger is in place"
      }
    ],

    "execution_status": "PENDING - Requires Migration 209 trigger deployment"
  },

  "section_5_current_state_assessment": {
    "trigger_deployed": false,
    "immutability_enforced": false,
    "enforcement_level": "POLICY_ONLY (not database-enforced)",

    "risk_assessment": {
      "risk": "Without trigger, UPDATE/DELETE are technically possible",
      "mitigation": "No authorized process performs UPDATE/DELETE on model_belief_state",
      "residual_risk": "LOW - social/procedural control until Migration 209"
    },

    "recommendation": "Deploy Migration 209 with immutability trigger before production activation"
  },

  "attestation": {
    "author": "STIG",
    "role": "Chief Technology Officer",
    "timestamp": "2026-01-06T21:00:00Z",
    "status": "APPROVED_WITH_FOLLOWUP",
    "followup_required": "Migration 209 - Immutability Trigger"
  }
}
