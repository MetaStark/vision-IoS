{
  "annex_id": "CEO-DIR-2026-FINN-004-ANNEX-A",
  "title": "Mandatory Provenance Snapshot (MPS) Schema Specification",
  "parent_directive": "CEO-DIR-2026-FINN-004",
  "classification": "NORMATIVE TECHNICAL SPECIFICATION",
  "status": "DRAFT",
  "date_drafted": "2025-12-30T22:30:00Z",
  "authority": ["ADR-002", "ADR-011", "ADR-013"],

  "purpose": {
    "statement": "This annex defines the exact schema, fields, and validation rules for the Mandatory Provenance Snapshot (MPS) artifact required by CEO-DIR-2026-FINN-004.",
    "legal_basis": "Without explicit schema specification, VEGA cannot formally block G0 proposals on missing MPS, rendering the directive unenforceable.",
    "enforcement_principle": "Any FINN execution producing a G0 proposal MUST generate a compliant MPS record. Non-compliant records SHALL be rejected by VEGA at G0 gate."
  },

  "schema_specification": {
    "table_name": "fhq_research.evidence_snapshot",
    "description": "Immutable provenance record for every FINN reasoning execution",

    "ddl": "CREATE TABLE IF NOT EXISTS fhq_research.evidence_snapshot (\n  snapshot_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  execution_id UUID NOT NULL,\n  g0_proposal_id TEXT,\n  session_id UUID NOT NULL,\n  query_text TEXT NOT NULL,\n  execution_timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  \n  -- Node lineage (exhaustive list)\n  evidence_nodes JSONB NOT NULL,\n  \n  -- Aggregated metrics\n  total_nodes_retrieved INTEGER NOT NULL,\n  total_nodes_used INTEGER NOT NULL,\n  total_edges_traversed INTEGER NOT NULL,\n  total_edges_used INTEGER NOT NULL,\n  \n  -- Tier breakdown\n  tier_breakdown JSONB NOT NULL,\n  lake_percentage NUMERIC(5,4) NOT NULL,\n  \n  -- SitC metrics (bifurcated per G3-2025-002)\n  sitc_chain_integrity NUMERIC(5,4) NOT NULL,\n  sitc_retrieval_discipline NUMERIC(5,4) NOT NULL,\n  \n  -- Hash binding\n  content_hash TEXT NOT NULL,\n  sha256_root_hash TEXT NOT NULL,\n  hash_prev TEXT,\n  \n  -- Signatures\n  vega_attestation_id TEXT,\n  vega_attested_at TIMESTAMPTZ,\n  human_countersignature TEXT,\n  human_signed_at TIMESTAMPTZ,\n  human_signer_identity TEXT,\n  \n  -- Governance status\n  g0_gate_status TEXT NOT NULL DEFAULT 'PENDING',\n  g0_gate_reason TEXT,\n  \n  -- Audit fields\n  created_by TEXT NOT NULL DEFAULT 'FINN',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  \n  -- Constraints\n  CONSTRAINT chk_lake_percentage CHECK (lake_percentage >= 0 AND lake_percentage <= 1),\n  CONSTRAINT chk_sitc_chain CHECK (sitc_chain_integrity >= 0 AND sitc_chain_integrity <= 1),\n  CONSTRAINT chk_sitc_retrieval CHECK (sitc_retrieval_discipline >= 0 AND sitc_retrieval_discipline <= 1),\n  CONSTRAINT chk_g0_status CHECK (g0_gate_status IN ('PENDING', 'APPROVED', 'REJECTED', 'HUMAN_OVERRIDE'))\n);",

    "indexes": [
      "CREATE INDEX idx_evidence_snapshot_execution ON fhq_research.evidence_snapshot(execution_id);",
      "CREATE INDEX idx_evidence_snapshot_session ON fhq_research.evidence_snapshot(session_id);",
      "CREATE INDEX idx_evidence_snapshot_g0 ON fhq_research.evidence_snapshot(g0_proposal_id);",
      "CREATE INDEX idx_evidence_snapshot_timestamp ON fhq_research.evidence_snapshot(execution_timestamp);"
    ],

    "immutability_trigger": "CREATE OR REPLACE FUNCTION fhq_research.prevent_snapshot_modification()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF TG_OP = 'UPDATE' THEN\n    -- Only allow signature fields to be updated\n    IF OLD.execution_id != NEW.execution_id OR\n       OLD.evidence_nodes != NEW.evidence_nodes OR\n       OLD.sha256_root_hash != NEW.sha256_root_hash THEN\n      RAISE EXCEPTION 'MPS core fields are immutable after creation';\n    END IF;\n  END IF;\n  IF TG_OP = 'DELETE' THEN\n    RAISE EXCEPTION 'MPS records cannot be deleted';\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER tr_mps_immutability\n  BEFORE UPDATE OR DELETE ON fhq_research.evidence_snapshot\n  FOR EACH ROW EXECUTE FUNCTION fhq_research.prevent_snapshot_modification();"
  },

  "field_specifications": {
    "snapshot_id": {
      "type": "UUID",
      "description": "Unique identifier for this provenance snapshot",
      "nullable": false,
      "auto_generated": true
    },
    "execution_id": {
      "type": "UUID",
      "description": "Unique identifier for the FINN execution that produced this snapshot",
      "nullable": false,
      "source": "Generated by FINN at execution start"
    },
    "g0_proposal_id": {
      "type": "TEXT",
      "description": "Reference to the G0 proposal this snapshot supports",
      "nullable": true,
      "note": "May be null if execution did not produce a proposal"
    },
    "session_id": {
      "type": "UUID",
      "description": "Session identifier for audit correlation",
      "nullable": false
    },
    "query_text": {
      "type": "TEXT",
      "description": "The exact query/hypothesis that triggered the execution",
      "nullable": false
    },
    "execution_timestamp": {
      "type": "TIMESTAMPTZ",
      "description": "UTC timestamp of execution",
      "nullable": false
    },
    "evidence_nodes": {
      "type": "JSONB",
      "description": "Exhaustive array of all evidence nodes involved in execution",
      "nullable": false,
      "schema": {
        "type": "array",
        "items": {
          "evidence_node_id": "UUID - Reference to fhq_canonical.evidence_nodes",
          "source_tier": "ENUM(LAKE, PULSE, SNIPER)",
          "ontology_concept_id": "TEXT - FIBO concept reference",
          "used_in_chain": "BOOLEAN - Whether node entered reasoning chain",
          "retrieval_rank": "INTEGER - Position in retrieval results",
          "confidence_score": "NUMERIC - Node confidence at retrieval",
          "content_hash": "TEXT - SHA-256 of node content",
          "timestamp_utc": "TIMESTAMPTZ - When node was retrieved"
        }
      }
    },
    "tier_breakdown": {
      "type": "JSONB",
      "description": "Count of nodes by source tier",
      "nullable": false,
      "schema": {
        "LAKE": "INTEGER - Count of LAKE-tier nodes used",
        "PULSE": "INTEGER - Count of PULSE-tier nodes used",
        "SNIPER": "INTEGER - Count of SNIPER-tier nodes used"
      }
    },
    "lake_percentage": {
      "type": "NUMERIC(5,4)",
      "description": "Percentage of used evidence from LAKE tier",
      "nullable": false,
      "constraint": "Must be between 0 and 1",
      "governance_rule": "If > 0.30, triggers Auto-IKEA per Section 2.2"
    },
    "sitc_chain_integrity": {
      "type": "NUMERIC(5,4)",
      "description": "SitC-Chain Integrity score per G3-2025-002",
      "nullable": false,
      "formula": "verified_items_used / total_items_used",
      "governance_rule": "Must be >= 0.80 for G0 approval, 1.00 for auto-progression"
    },
    "sitc_retrieval_discipline": {
      "type": "NUMERIC(5,4)",
      "description": "SitC-Retrieval Discipline score per G3-2025-002",
      "nullable": false,
      "formula": "verified_items_used / total_items_retrieved",
      "governance_rule": "Observational in 2026, escalation if < 0.50 for 3 consecutive runs"
    },
    "sha256_root_hash": {
      "type": "TEXT",
      "description": "SHA-256 hash of the complete snapshot for integrity verification",
      "nullable": false,
      "computation": "SHA-256(JSON.stringify(snapshot_without_signature_fields, sort_keys=True))",
      "purpose": "Enables cryptographic verification that snapshot has not been tampered with"
    },
    "vega_attestation_id": {
      "type": "TEXT",
      "description": "Reference to VEGA attestation record",
      "nullable": true,
      "note": "Required for G0 gate passage without human override"
    },
    "human_countersignature": {
      "type": "TEXT",
      "description": "Human-provided signature for override scenarios",
      "nullable": true,
      "format": "Base64-encoded Ed25519 signature or text acknowledgment"
    },
    "human_signer_identity": {
      "type": "TEXT",
      "description": "Identity of human signer (CEO or delegated CEIO)",
      "nullable": true,
      "allowed_values": ["CEO", "CEIO", "DELEGATED_AUTHORITY"]
    },
    "g0_gate_status": {
      "type": "TEXT",
      "description": "Current G0 gate status for this snapshot",
      "nullable": false,
      "allowed_values": ["PENDING", "APPROVED", "REJECTED", "HUMAN_OVERRIDE"]
    }
  },

  "validation_rules": {
    "mps_completeness": {
      "rule": "All required fields must be populated",
      "enforcement": "Database NOT NULL constraints",
      "failure_action": "INSERT rejected"
    },
    "lake_quota_check": {
      "rule": "lake_percentage must be calculated correctly from tier_breakdown",
      "enforcement": "Application-level validation + VEGA audit",
      "failure_action": "G0 gate rejection"
    },
    "hash_integrity": {
      "rule": "sha256_root_hash must match recomputed hash of snapshot",
      "enforcement": "VEGA verification at G0 gate",
      "failure_action": "G0 gate rejection with INTEGRITY_VIOLATION flag"
    },
    "node_lineage_completeness": {
      "rule": "Every node in evidence_nodes must have all required sub-fields",
      "enforcement": "JSONB schema validation",
      "failure_action": "INSERT rejected"
    }
  },

  "vega_gate_integration": {
    "g0_gate_check": {
      "trigger": "Before any G0 proposal can advance to G1",
      "validation_steps": [
        "1. Verify MPS record exists for execution_id",
        "2. Verify sha256_root_hash integrity",
        "3. Check sitc_chain_integrity >= 0.80",
        "4. Check lake_percentage <= 0.30 OR Auto-IKEA triggered",
        "5. Verify VEGA attestation OR human countersignature present"
      ],
      "rejection_codes": {
        "MPS_MISSING": "No MPS record found for execution",
        "HASH_MISMATCH": "SHA-256 root hash verification failed",
        "SITC_BELOW_THRESHOLD": "Chain Integrity below 0.80",
        "LAKE_QUOTA_EXCEEDED": "LAKE percentage > 30% without Auto-IKEA",
        "SIGNATURE_MISSING": "Neither VEGA attestation nor human signature present"
      }
    }
  },

  "migration_reference": {
    "migration_number": 177,
    "migration_file": "177_mandatory_provenance_snapshot.sql",
    "dependencies": ["Migration 176 (InForage Source-Tier Enforcement)"],
    "rollback_strategy": "DROP TABLE fhq_research.evidence_snapshot CASCADE;"
  },

  "attestation": {
    "drafted_by": "STIG (CTO)",
    "reviewed_by": "VEGA (Governance Authority)",
    "status": "DRAFT - PENDING RATIFICATION",
    "ratification_deadline": "7 days from parent directive signature"
  }
}
