{
  "evidence_id": "R4-SCHEDULING-SINGLE-SOURCE-001",
  "evidence_type": "CODE_DEPLOYMENT_METRONOME_FIX",
  "evidence_timestamp": "2026-01-09T00:40:00Z",
  "directive_reference": "CEO-DIR-2026-024: R4 Scheduling Single Source of Truth",
  "generated_by": "STIG",
  "classification": "G4_OPERATIONAL_FIX",
  "priority": "P1",
  "status": "CODE_CHANGED_RESTART_REQUIRED",

  "executive_summary": {
    "problem": "R4 triggered by BOTH timer AND chain hook → irregular intervals (2min, 8min vs 10min metronome)",
    "root_cause": "Double trigger: (1) Standalone R4 every 600s, (2) R4 in full CNRP chain every 4h, with timer reset on chain run",
    "solution": "Single source of truth: R4 timer-only (600s metronome), removed from CNRP chain",
    "expected_result": "Perfect metronome rhythm: 600s ±1s between all R4 probes",
    "restart_required": true
  },

  "problem_diagnosis": {
    "symptom": "R4 probe intervals irregular",
    "observed_intervals": [
      {"from": "00:24:35", "to": "00:32:10", "interval_seconds": 455, "expected": 600},
      {"from": "00:32:10", "to": "00:34:35", "interval_seconds": 145, "expected": 600},
      {"from": "00:34:35", "to": "00:42:10", "interval_seconds": 455, "expected": 600}
    ],
    "root_cause_analysis": {
      "trigger_1": "Timer-based R4 standalone (line 1091-1098): every 600s",
      "trigger_2": "Chain-based R4 (line 649-652): as part of R1→R2→R3→R4 every 4h",
      "conflict": "Line 1084: `last_r4_monitor = now` when chain runs → resets timer → breaks metronome",
      "result": "R4 runs at unpredictable intervals depending on when chain starts"
    }
  },

  "code_changes": {
    "file": "05_ORCHESTRATOR/orchestrator_v1.py",
    "scope": "R4 scheduling logic only - no other changes",
    "changes_applied": [
      {
        "change_id": "1_remove_r4_from_chain",
        "line": 649,
        "before": "phases = ['R1', 'R2', 'R3', 'R4']",
        "after": "phases = ['R1', 'R2', 'R3']  # CEO-DIR-2026-024: R4 timer-only",
        "rationale": "R4 removed from causal chain - runs independently via timer"
      },
      {
        "change_id": "2_remove_chain_delays",
        "line": 651,
        "before": "delays = [0, R1_TO_R2, R2_TO_R3, R3_TO_R4]",
        "after": "delays = [0, R1_TO_R2, R2_TO_R3]",
        "rationale": "R3_TO_R4 delay no longer needed (R4 not in chain)"
      },
      {
        "change_id": "3_remove_timer_reset",
        "line": 1084,
        "before": "last_r4_monitor = now  # R4 was part of chain",
        "after": "# CEO-DIR-2026-024: R4 timer-only, do NOT reset last_r4_monitor here",
        "rationale": "Chain execution no longer resets R4 timer → perfect metronome"
      },
      {
        "change_id": "4_add_schedule_source_metadata",
        "line": 577,
        "before": "def log_cnrp_execution(self, cycle_id, phase, status, result, authority):",
        "after": "def log_cnrp_execution(self, cycle_id, phase, status, result, authority, schedule_source=None):",
        "rationale": "Log r4_schedule_source in metadata for metronome verification"
      },
      {
        "change_id": "5_log_timer_source",
        "line": 596,
        "added": "if phase == 'R4' and schedule_source:\n    metadata['r4_schedule_source'] = schedule_source",
        "rationale": "Metadata proves R4 triggered by timer (not chain)"
      },
      {
        "change_id": "6_pass_timer_source",
        "line": 719,
        "before": "self.log_cnrp_execution(..., 'VEGA')",
        "after": "self.log_cnrp_execution(..., 'VEGA', schedule_source='timer')",
        "rationale": "R4 standalone explicitly logs schedule_source='timer'"
      },
      {
        "change_id": "7_update_docstrings",
        "lines": [633, 701, 1054, 1068],
        "changes": [
          "run_chain: R1→R2→R3 (was R1→R2→R3→R4)",
          "run_r4_standalone: '600s metronome, not in chain'",
          "run_cnrp_continuous: '10 minutes (timer-only metronome)'",
          "log output: '10 minutes - timer-only metronome'"
        ],
        "rationale": "Documentation matches new behavior"
      }
    ]
  },

  "new_behavior": {
    "cnrp_full_chain": {
      "schedule": "Every 4 hours",
      "phases": "R1 → R2 → R3 (R4 removed)",
      "duration": "~8 minutes (R1: 5min, R2: 2min, R3: 1min)",
      "r4_behavior": "Chain does NOT trigger R4, does NOT reset R4 timer"
    },

    "r4_standalone_monitor": {
      "schedule": "Every 600 seconds (timer-only)",
      "trigger": "time.time() - last_r4_monitor >= 600",
      "independence": "Runs completely independently of CNRP chain schedule",
      "metronome": "Perfect 600s ±1s rhythm (no chain interference)",
      "metadata": "r4_schedule_source: 'timer' (proves single source of truth)"
    },

    "expected_intervals": {
      "r4_to_r4": "600 seconds ±1s (metronome)",
      "r1_cycle_to_next_r1_cycle": "14400 seconds (4 hours)",
      "r4_during_chain": "R4 continues timer schedule, ignores chain timing"
    }
  },

  "verification_queries": {
    "verify_r4_metronome": {
      "sql": "SELECT timestamp AT TIME ZONE 'UTC' AS timestamp_utc, LAG(timestamp) OVER (ORDER BY timestamp) AS previous, EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (ORDER BY timestamp)))::INTEGER AS interval_sec, metadata->>'r4_schedule_source' AS schedule_source FROM fhq_governance.governance_actions_log WHERE action_target = 'CNRP-R4' AND timestamp >= NOW() - INTERVAL '2 hours' ORDER BY timestamp;",
      "expected": "All intervals ~600s ±5s, all schedule_source = 'timer'"
    },

    "verify_chain_phases": {
      "sql": "SELECT action_target, timestamp FROM fhq_governance.governance_actions_log WHERE metadata->>'cycle_id' LIKE 'CNRP-%' AND timestamp >= NOW() - INTERVAL '6 hours' ORDER BY timestamp;",
      "expected": "Sequence: CNRP-R1, CNRP-R2, CNRP-R3 (no CNRP-R4 in chain)"
    }
  },

  "restart_instructions": {
    "method": "Stop and restart orchestrator to apply changes",
    "steps": [
      "1. Go to orchestrator CMD window (title: 'FjordHQ Orchestrator')",
      "2. Press Ctrl+C to stop orchestrator gracefully",
      "3. Double-click START_SYSTEM.bat (or run: python orchestrator_v1.py --cnrp-continuous)",
      "4. Verify startup log shows: 'R4 Monitor Interval: 600s (10 minutes - timer-only metronome)'",
      "5. Monitor for 20 minutes (2 R4 probes) to verify 600s intervals"
    ],
    "verification_window": "Within 20 minutes after restart, should see 2 R4 probes with ~600s interval",
    "fallback": "If issues persist, check orchestrator window for errors"
  },

  "expected_post_restart_behavior": {
    "first_r4_probe": "Within 600s of orchestrator start",
    "second_r4_probe": "600s ±5s after first probe",
    "third_r4_probe": "600s ±5s after second probe",
    "metadata_verification": "All R4 probes have r4_schedule_source = 'timer'",
    "no_chain_r4": "CNRP chains show only R1→R2→R3 (no R4)"
  },

  "watch_items_addressed": {
    "ceo_watch_item": "Get 600s metronome to stabilize (not 2min, 8min variations)",
    "solution_applied": "Single source of truth: timer-only R4, removed from chain",
    "metadata_logging": "r4_schedule_source field added to prove scheduling source",
    "next_verification": "After restart, query governance_actions_log to verify perfect 600s rhythm"
  },

  "stig_certification": {
    "statement": "I, STIG (CTO), certify that R4 scheduling has been converted to single source of truth (timer-only). R4 removed from CNRP chain (phases now R1→R2→R3). Chain execution no longer resets R4 timer. Metadata field r4_schedule_source added for metronome verification. Expected result: Perfect 600-second metronome rhythm. Orchestrator restart required for changes to take effect. Zero changes to Phase 5 Lock, thresholds, or learning parameters.",
    "signature": "STIG-R4-METRONOME-SINGLE-SOURCE-001",
    "timestamp": "2026-01-09T00:40:00Z",
    "restart_required": true,
    "verification_method": "Query governance_actions_log after restart, verify 600s ±5s intervals and r4_schedule_source='timer'",
    "mantra": "Eliminate Noise. Generate Signal. Move fast and verify things."
  },

  "lineage_hash": "f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2"
}
