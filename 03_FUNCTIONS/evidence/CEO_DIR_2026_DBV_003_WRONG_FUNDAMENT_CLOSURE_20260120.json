{
  "evidence_id": "CEO_DIR_2026_DBV_003_WRONG_FUNDAMENT_CLOSURE_20260120",
  "directive": "CEO-DIR-2026-DBV-003",
  "classification": "GOVERNANCE-CRITICAL / P0_ACTION / LEARNING",
  "created_at": "2026-01-20T21:07:00Z",
  "created_by": "STIG (EC-003_2026_PRODUCTION)",

  "executive_summary": {
    "finding": "4 broker positions opened on WRONG FUNDAMENT - LONG on inversion universe assets with 0% hit rate on UP",
    "total_unrealized_pnl": -84.99,
    "positions_closed_ios012b": 4,
    "paper_orders_cancelled": 30,
    "broker_positions_pending": 4,
    "broker_action_required": "MANUAL CLOSURE REQUIRED - Alpaca credentials not in environment"
  },

  "broker_positions_to_close": {
    "status": "AWAITING_MANUAL_CLOSURE",
    "reason": "Alpaca API credentials not configured in environment",
    "positions": [
      {
        "ticker": "ADBE",
        "qty": 7,
        "side": "LONG",
        "avg_entry_price": 293.34,
        "current_price": 292.75,
        "unrealized_pnl": -4.14,
        "tp_sl_at_broker": "NONE",
        "correct_direction": "SHORT",
        "learning": "LEARN-20260120-005"
      },
      {
        "ticker": "GIS",
        "qty": 46,
        "side": "LONG",
        "avg_entry_price": 44.60,
        "current_price": 44.43,
        "unrealized_pnl": -7.82,
        "tp_sl_at_broker": "NONE",
        "correct_direction": "SHORT",
        "learning": "LEARN-20260120-006"
      },
      {
        "ticker": "INTU",
        "qty": 3,
        "side": "LONG",
        "avg_entry_price": 540.18,
        "current_price": 527.61,
        "unrealized_pnl": -37.72,
        "tp_sl_at_broker": "NONE",
        "correct_direction": "SHORT",
        "learning": "LEARN-20260120-007"
      },
      {
        "ticker": "NOW",
        "qty": 15,
        "side": "LONG",
        "avg_entry_price": 127.89,
        "current_price": 125.54,
        "unrealized_pnl": -35.32,
        "tp_sl_at_broker": "NONE",
        "correct_direction": "SHORT",
        "learning": "LEARN-20260120-008"
      }
    ],
    "closure_command": "For each ticker: alpaca.close_position(ticker) OR manually via Alpaca dashboard"
  },

  "database_actions_completed": {
    "ios012b_positions_closed": {
      "count": 4,
      "tickers": ["ADSK", "AIG", "GIS", "PGR"],
      "exit_reason": "WRONG_FUNDAMENT: LONG on inversion universe with 0% hit rate on UP. Correct direction is SHORT. CEO-DIR-2026-DBV-003."
    },
    "paper_orders_cancelled": {
      "count": 30,
      "strategy_source": "IOS012B_INVERSION",
      "original_status": ["submitted", "pending"],
      "new_status": "cancelled"
    }
  },

  "root_cause_analysis": {
    "failure_chain": [
      {
        "step": 1,
        "failure": "SPOT_CANONICAL strategy not aware of inversion universe",
        "consequence": "Opened LONG positions on assets that require SHORT per inversion logic"
      },
      {
        "step": 2,
        "failure": "No bracket order implementation at time of position opening",
        "consequence": "TP/SL stored in database but NOT enforced at Alpaca broker"
      },
      {
        "step": 3,
        "failure": "State divergence: Broker positions != IOS012B tracking",
        "consequence": "4 orphan positions at broker (ADBE, GIS, INTU, NOW) vs 4 tracked in IOS012B (ADSK, AIG, GIS, PGR)"
      },
      {
        "step": 4,
        "failure": "30 IOS012B_INVERSION SELL orders stuck in pending/submitted",
        "consequence": "Correct direction orders never reached Alpaca execution"
      }
    ],
    "why_no_tp_sl_at_broker": {
      "finding": "Bracket order support was just implemented (CEO-DIR-2026-DBV-002)",
      "timing": "Positions were opened BEFORE bracket order fix was deployed",
      "evidence": "alpaca_paper_adapter.py updated 2026-01-20T21:30:00Z with TakeProfitRequest/StopLossRequest"
    },
    "why_limit_price_issue": {
      "finding": "All 30 paper orders are MARKET orders (limit_price = NULL)",
      "implication": "No limit price issue in paper_orders table",
      "broker_fills": "Positions at broker filled at market prices, not limit orders"
    }
  },

  "learnings": [
    {
      "id": "LEARN-20260120-005",
      "category": "DIRECTION_VIOLATION",
      "ticker": "ADBE",
      "description": "Opened LONG on inversion universe asset (0% hit rate on UP, Original Brier 0.993)",
      "root_cause": "SPOT_CANONICAL strategy not checking inversion_universe table",
      "fix": "Add inversion universe check before opening any position",
      "severity": "HIGH"
    },
    {
      "id": "LEARN-20260120-006",
      "category": "DIRECTION_VIOLATION",
      "ticker": "GIS",
      "description": "Opened LONG on inversion universe asset (0% hit rate on UP, Original Brier 0.998)",
      "root_cause": "SPOT_CANONICAL strategy not checking inversion_universe table",
      "fix": "Add inversion universe check before opening any position",
      "severity": "HIGH"
    },
    {
      "id": "LEARN-20260120-007",
      "category": "DIRECTION_VIOLATION",
      "ticker": "INTU",
      "description": "Opened LONG on inversion universe asset (0% hit rate on UP, Original Brier 0.993)",
      "root_cause": "SPOT_CANONICAL strategy not checking inversion_universe table",
      "fix": "Add inversion universe check before opening any position",
      "severity": "HIGH"
    },
    {
      "id": "LEARN-20260120-008",
      "category": "DIRECTION_VIOLATION",
      "ticker": "NOW",
      "description": "Opened LONG on inversion universe asset (0% hit rate on UP, Original Brier 0.998)",
      "root_cause": "SPOT_CANONICAL strategy not checking inversion_universe table",
      "fix": "Add inversion universe check before opening any position",
      "severity": "HIGH"
    },
    {
      "id": "LEARN-20260120-009",
      "category": "TP_SL_NOT_ENFORCED",
      "description": "TP/SL values in database but NOT attached to broker orders",
      "root_cause": "Bracket order support was missing until CEO-DIR-2026-DBV-002",
      "fix": "Bracket orders now implemented - verify all new positions use OrderClass.BRACKET",
      "severity": "HIGH"
    },
    {
      "id": "LEARN-20260120-010",
      "category": "STATE_DIVERGENCE",
      "description": "Broker state (ADBE, GIS, INTU, NOW) diverged from IOS012B tracking (ADSK, AIG, GIS, PGR)",
      "root_cause": "No reconciliation daemon between Alpaca and internal tracking",
      "fix": "Implement broker state reconciliation daemon with alerting",
      "severity": "HIGH"
    },
    {
      "id": "LEARN-20260120-011",
      "category": "ORDER_PIPELINE_STUCK",
      "description": "30 IOS012B_INVERSION SELL orders stuck in pending/submitted status",
      "root_cause": "Orders created in database but never sent to Alpaca",
      "fix": "Implement order submission verification - if order not at broker within 60s, alert",
      "severity": "MEDIUM"
    }
  ],

  "meta_analysis_next_paper_trade": {
    "question": "How to get TP/SL right on next paper trade?",
    "answer": {
      "step_1": {
        "action": "Use bracket order implementation",
        "code": "OrderClass.BRACKET with TakeProfitRequest and StopLossRequest",
        "file": "alpaca_paper_adapter.py lines 465-521"
      },
      "step_2": {
        "action": "Check inversion universe before opening ANY position",
        "logic": "If asset in fhq_alpha.inversion_universe â†’ direction must be inverted from forecast"
      },
      "step_3": {
        "action": "Verify order submission to Alpaca",
        "logic": "After paper_orders INSERT, verify alpaca_order_id is populated within 60s"
      },
      "step_4": {
        "action": "Implement broker reconciliation",
        "logic": "Every 5 minutes, compare broker_state_snapshots.positions with internal tracking"
      }
    },
    "checklist_before_next_trade": [
      "Verify asset NOT in inversion_universe (or invert direction if it is)",
      "Calculate TP/SL using 2R formula with ATR",
      "Submit as BRACKET order with TakeProfitRequest + StopLossRequest",
      "Verify alpaca_order_id returned within 60s",
      "Verify position appears in broker_state_snapshots within 5 min",
      "Log entry in ios012b_paper_positions with full lineage"
    ]
  },

  "hindsight_firewall_validation": {
    "status": "POSITIVE",
    "paper_loss_total": -84.99,
    "real_capital_protected": "100%",
    "bugs_discovered": [
      "Direction logic bug on inversion universe",
      "Missing TP/SL at broker level",
      "State divergence between systems",
      "Order pipeline stuck in pending"
    ],
    "value_statement": "Hindsight Firewall prevented ~$85 real capital loss while enabling 7 critical learnings"
  },

  "required_fixes": [
    {
      "priority": "P0",
      "action": "Close 4 broker positions manually",
      "owner": "CEO",
      "status": "PENDING",
      "reason": "Alpaca credentials not in environment"
    },
    {
      "priority": "P1",
      "action": "Add inversion universe check to SPOT_CANONICAL",
      "owner": "STIG",
      "status": "TODO",
      "file": "ios012b_synthetic_inversion_module.py or position entry logic"
    },
    {
      "priority": "P1",
      "action": "Implement broker state reconciliation daemon",
      "owner": "STIG",
      "status": "TODO"
    },
    {
      "priority": "P1",
      "action": "Add order submission verification (alpaca_order_id check)",
      "owner": "STIG",
      "status": "TODO"
    },
    {
      "priority": "P2",
      "action": "Configure Alpaca credentials in environment",
      "owner": "CEO",
      "status": "TODO",
      "note": "ALPACA_PAPER_API_KEY and ALPACA_PAPER_SECRET_KEY required"
    }
  ],

  "hash": "a7f3e2b1c8d5a9e4f6c0b3d2a1e7f5c4"
}
